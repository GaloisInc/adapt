<!DOCTYPE html>

<meta charset="utf-8">
<head>
    <script type="text/javascript" src="{{ url_for('static', filename='jquery.3.1.0.min.js') }}"></script>
    <script type="text/javascript" src="{{ url_for('static', filename='underscore.js') }}"></script>
    <script type="text/javascript" src="{{ url_for('static', filename='vis.4.16.1.js') }}"></script>
    <link href="{{ url_for('static', filename='vis.4.16.1.css') }}" rel="stylesheet" type="text/css" />

    <script type="text/javascript">
        function queryClick() { 
            $('#query-string').css("background-color", "white")
            var query_string = document.getElementById('query-string').value
            
            $.post("/query", {"query": query_string}, function(node_results) {
                var all_ids = {}  // poor man's Set. I hate javascript!
                var nodes = _.filter(node_results, function(i) { return i['type'] == "vertex" })
                nodes = _.map(nodes, function(v, i, list) {
                    all_ids[v['id']] = true
                    var keys = Object.keys(v['properties'])
                    var prop_lines = _.map(keys, function(key, i, list) {
                        return key + " : " + v['properties'][key][0]['value']  // WARNING: this [0] might throw away data somewhere (but not in any data that I see)
                    })
                    var node = { 
                        "id" : v['id'],
                        "label" : makeNodeLabel(v),
                        "title" : "id : " + v['id'] + "<br />" + prop_lines.join("<br />")
                    }
                    return node
                })

                var node_id_list = _.map(nodes, function(n) { return n['id'] })
                var node_text_string = node_id_list.join(",")
                var edge_query = "g.V([" + node_text_string + "].toArray()).both()"

                console.log("Found nodes: " + nodes.length)

                $.post("/query", {"query": edge_query}, function(edge_results) {
                    var edges = _.filter(edge_results, function(i) { return i['type'] == "edge" })
                    edges = _.map(edges, function(e, i, list) {
                        return { "from" : e['outV'],
                                 "to" : e['inV'],
                                 // "label" : e['label'],
                                 "arrows" : "to",
                                 "title" : e['label'] }
                    })
                    console.log("Found edges: " + edges.length)
                    draw( { "nodes" : nodes, "edges" : edges } )
                }).fail(failHandler)
            }).fail(failHandler)
        }


        function failHandler(response) {
            $('#query-string').css("background-color", "pink")
        }


        function draw(data) {
            var container = document.getElementById('graph');
            var options = {
                interaction : { hover : true },
                layout: { 
                    improvedLayout : false,
                    randomSeed : 10203040
                }
            };
            var network = new vis.Network(container, data, options);

            // TODO:
            network.on("doubleClick", function (params) {
                params.event = "[original event]";
                console.log(JSON.stringify(params, null, 4))
            });
        }


        function clearInput() {
            $("#query-string").css("background-color", "white")
        }


        function makeNodeLabel(node) {
            if (node['label'] == "Subject") {
                var t = (node['properties'].hasOwnProperty('subjectType') ? node['properties']['subjectType'][0]['value'] : "None")
                var e = (node['properties'].hasOwnProperty('eventType') ? node['properties']['eventType'][0]['value'] : "None")
                var pid = (node['properties'].hasOwnProperty('pid') ? node['properties']['pid'][0]['value'] : "None")
                return "(S) T: " + t + ", E: " + e + ", PID: " + pid
            } else if (node['label'] == "Entity-File") {
                var url = (node['properties'].hasOwnProperty('url') ? node['properties']['url'][0]['value'] : "None")
                var file_version = (node['properties'].hasOwnProperty('file-version') ? node['properties']['file-version'][0]['value'] : "None")
                return "(F) " + url + " : " + file_version
            } else {
                return node['label'].replace(/^(EDGE_)/,"").replace(/^(EVENT_)/,"")
            }
        }
    </script>

    <style type="text/css">
        html, body, #graph {
            padding: 0px;
            margin: 0px;
            height: 100%;
            width: 100%;
        }
    </style>
</head>
<body>
    <input id="query-string" value="g.V().limit(100)" placeholder="Query returning nodes" onfocus="clearInput()" autofocus onkeyup="if (event.keyCode == 13) document.getElementById('query-button').click()" />
    <button id="query-button" onclick="queryClick()">Query</button>
    <div id="graph"></div>
</body>
</html>