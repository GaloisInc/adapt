{
    "netflow" : {
        "description" : "Analyze netflow nodes i.e. network sockets for possible anomalous behavior",
        "instance_set" : "g.V().has('eventType',6).out('EDGE_EVENT_AFFECTS_NETFLOW out').out('EDGE_EVENT_AFFECTS_NETFLOW in').dedup().id()",
        "feature_set" : {
            "write_bytes":
                "x={id};g.V(x).in('EDGE_EVENT_AFFECTS_NETFLOW in').in('EDGE_EVENT_AFFECTS_NETFLOW out').has('eventType',21).values('size').sum()",
            "read_bytes":
                "x={id};g.V(x).in('EDGE_EVENT_AFFECTS_NETFLOW in').in('EDGE_EVENT_AFFECTS_NETFLOW out').has('eventType',17).values('size').sum()",
            "num_writes":
                "x={id};g.V(x).in('EDGE_EVENT_AFFECTS_NETFLOW in').in('EDGE_EVENT_AFFECTS_NETFLOW out').has('eventType',21).count()",
            "num_reads":
                "x={id};g.V(x).in('EDGE_EVENT_AFFECTS_NETFLOW in').in('EDGE_EVENT_AFFECTS_NETFLOW out').has('eventType',17).count()",
            "num_open":
                "x={id};g.V(x).in('EDGE_EVENT_AFFECTS_NETFLOW in').in('EDGE_EVENT_AFFECTS_NETFLOW out').has('eventType',16).count()",
            "num_close":
                "x={id};g.V(x).in('EDGE_EVENT_AFFECTS_NETFLOW in').in('EDGE_EVENT_AFFECTS_NETFLOW out').has('eventType',5).count()",
            "duration":
                "x={id};y=g.V(x).in('EDGE_EVENT_AFFECTS_NETFLOW in').in('EDGE_EVENT_AFFECTS_NETFLOW out').has('subjectType',4).values('startedAtTime').max().next();x={id};z=g.V(x).in('EDGE_EVENT_AFFECTS_NETFLOW in').in('EDGE_EVENT_AFFECTS_NETFLOW out').has('eventType',6).values('startedAtTime').min().next();(y-z)/1.0e6"
        }
    },

    "netflow_connect_process_exec" : {
        "description" : "Analyze netflow nodes that have connection with file execution (potential remote execution command)",
        "instance_set" : "g.V().has('eventType',6).out('EDGE_EVENT_AFFECTS_NETFLOW out').out('EDGE_EVENT_AFFECTS_NETFLOW in').dedup().as('netflow').in('EDGE_EVENT_AFFECTS_NETFLOW in').in('EDGE_EVENT_AFFECTS_NETFLOW out').out('EDGE_EVENT_ISGENERATEDBY_SUBJECT out').out('EDGE_EVENT_ISGENERATEDBY_SUBJECT in').dedup().in('EDGE_EVENT_ISGENERATEDBY_SUBJECT in').in('EDGE_EVENT_ISGENERATEDBY_SUBJECT out').has('eventType',9).select('netflow').dedup().id()",
        "feature_set" : {
            "write_bytes":
                "x={id};g.V(x).in('EDGE_EVENT_AFFECTS_NETFLOW in').in('EDGE_EVENT_AFFECTS_NETFLOW out').has('eventType',21).values('size').sum()",
            "read_bytes":
                "x={id};g.V(x).in('EDGE_EVENT_AFFECTS_NETFLOW in').in('EDGE_EVENT_AFFECTS_NETFLOW out').has('eventType',17).values('size').sum()",
            "num_writes":
                "x={id};g.V(x).in('EDGE_EVENT_AFFECTS_NETFLOW in').in('EDGE_EVENT_AFFECTS_NETFLOW out').has('eventType',21).count()",
            "num_reads":
                "x={id};g.V(x).in('EDGE_EVENT_AFFECTS_NETFLOW in').in('EDGE_EVENT_AFFECTS_NETFLOW out').has('eventType',17).count()",
            "num_open":
                "x={id};g.V(x).in('EDGE_EVENT_AFFECTS_NETFLOW in').in('EDGE_EVENT_AFFECTS_NETFLOW out').has('eventType',16).count()",
            "num_close":
                "x={id};g.V(x).in('EDGE_EVENT_AFFECTS_NETFLOW in').in('EDGE_EVENT_AFFECTS_NETFLOW out').has('eventType',5).count()",
            "duration":
                "x={id};y=g.V(x).in('EDGE_EVENT_AFFECTS_NETFLOW in').in('EDGE_EVENT_AFFECTS_NETFLOW out').has('subjectType',4).values('startedAtTime').max().next();x={id};z=g.V(x).in('EDGE_EVENT_AFFECTS_NETFLOW in').in('EDGE_EVENT_AFFECTS_NETFLOW out').has('eventType',6).values('startedAtTime').min().next();(y-z)/1.0e6"
        }
    },

    "netflow_connect_last_activity_gap" : {
        "description" : "Identify netflow nodes that are open for long time",
        "instance_set": "g.V().has('eventType',6).out('EDGE_EVENT_AFFECTS_NETFLOW out').out('EDGE_EVENT_AFFECTS_NETFLOW in').dedup().id()",
        "feature_set": {
            "connect_last_activity_gap":
                "x={id};y=g.V(x).in('EDGE_EVENT_AFFECTS_NETFLOW in').in('EDGE_EVENT_AFFECTS_NETFLOW out').has('subjectType',4).values('startedAtTime').max().next();x={id};z=g.V(x).in('EDGE_EVENT_AFFECTS_NETFLOW in').in('EDGE_EVENT_AFFECTS_NETFLOW out').has('eventType',6).values('startedAtTime').min().next();(y-z)/1.0e6"
        }
    },

    "netflow_long_write_delay" : {
        "description" : "Identify netflow nodes with long writing delay (potential exfiltration)",
        "instance_set": "g.V().has('dstAddress',textContains('.')).as('netflow').local(__.in('EDGE_EVENT_AFFECTS_NETFLOW in').in('EDGE_EVENT_AFFECTS_NETFLOW out').has('eventType',21).count().is(gt(1))).select('netflow').dedup().id()",
        "feature_set": {
            "first_last_write_gap":
                "(x={id};y=g.V(x).in('EDGE_EVENT_AFFECTS_NETFLOW in').in('EDGE_EVENT_AFFECTS_NETFLOW out').has('eventType',21).values('startedAtTime').max().next();x={id};z=g.V(x).in('EDGE_EVENT_AFFECTS_NETFLOW in').in('EDGE_EVENT_AFFECTS_NETFLOW out').has('eventType',21).values('startedAtTime').min().next();(y-z)/1.0e6",
            "num_writes":
                "x={id};g.V(x).in('EDGE_EVENT_AFFECTS_NETFLOW in').in('EDGE_EVENT_AFFECTS_NETFLOW out').has('eventType',21).count()"
        }
    },



    "process_connected_with_netflow" : {
        "description" : "Analyze process nodes that have network activity",
        "instance_set" : "g.V().has('subjectType',0).as('process').in('EDGE_EVENT_ISGENERATEDBY_SUBJECT in').in('EDGE_EVENT_ISGENERATEDBY_SUBJECT out').out('EDGE_EVENT_AFFECTS_NETFLOW out').out('EDGE_EVENT_AFFECTS_NETFLOW in').select('process').dedup().id()",
        "feature_set" : {
            "num_file_open_during_wr_to_netflow":
                "x={id};g.V(x).as('process').in('EDGE_EVENT_ISGENERATEDBY_SUBJECT in').in('EDGE_EVENT_ISGENERATEDBY_SUBJECT out').has('eventType',21).as('writeNetflow').out('EDGE_EVENT_AFFECTS_NETFLOW out').out('EDGE_EVENT_AFFECTS_NETFLOW in').select('process').in('EDGE_EVENT_ISGENERATEDBY_SUBJECT in').in('EDGE_EVENT_ISGENERATEDBY_SUBJECT out').has('eventType',16).as('openFile').out('EDGE_EVENT_AFFECTS_FILE out').out('EDGE_EVENT_AFFECTS_FILE in').select('writeNetflow','openFile').by('startedAtTime').where('writeNetflow',gte('openFile')).count()",
            "num_distinct_dst_port_access":
                "x={id};g.V(x).in('EDGE_EVENT_ISGENERATEDBY_SUBJECT in').in('EDGE_EVENT_ISGENERATEDBY_SUBJECT out').out('EDGE_EVENT_AFFECTS_NETFLOW out').out('EDGE_EVENT_AFFECTS_NETFLOW in').values('dstPort').dedup().count()",
            "num_distinct_src_port_access":
                "x={id};g.V(x).in('EDGE_EVENT_ISGENERATEDBY_SUBJECT in').in('EDGE_EVENT_ISGENERATEDBY_SUBJECT out').out('EDGE_EVENT_AFFECTS_NETFLOW out').out('EDGE_EVENT_AFFECTS_NETFLOW in').values('srcPort').dedup().count()",
            "total_bytes_sent_to_netflow":
                "x={id};g.V(x).in('EDGE_EVENT_ISGENERATEDBY_SUBJECT in').in('EDGE_EVENT_ISGENERATEDBY_SUBJECT out').has('eventType',21).as('event').out('EDGE_EVENT_AFFECTS_NETFLOW out').out('EDGE_EVENT_AFFECTS_NETFLOW in').select('event').has('size').values('size').sum()",
            "total_bytes_rcv_from_netflow":
                "x={id};g.V(x).in('EDGE_EVENT_ISGENERATEDBY_SUBJECT in').in('EDGE_EVENT_ISGENERATEDBY_SUBJECT out').has('eventType',17).as('event').out('EDGE_EVENT_AFFECTS_NETFLOW out').out('EDGE_EVENT_AFFECTS_NETFLOW in').select('event').has('size').values('size').sum()",
            "num_writes_to_net_flow":
                "x={id};g.V(x).in('EDGE_EVENT_ISGENERATEDBY_SUBJECT in').in('EDGE_EVENT_ISGENERATEDBY_SUBJECT out').has('eventType',21).out('EDGE_EVENT_AFFECTS_NETFLOW out').out('EDGE_EVENT_AFFECTS_NETFLOW in').count()",
            "num_reads_to_netflow":
                "x={id};g.V(x).in('EDGE_EVENT_ISGENERATEDBY_SUBJECT in').in('EDGE_EVENT_ISGENERATEDBY_SUBJECT out').has('eventType',17).out('EDGE_EVENT_AFFECTS_NETFLOW out').out('EDGE_EVENT_AFFECTS_NETFLOW in').count()"
        }
    },

    "process_connect_many_netflow" : {
        "description": "Analyze process nodes that have many distinct network activity within same network hosts",
        "instance_set": "g.V().has('subjectType',0).as('process').in('EDGE_EVENT_ISGENERATEDBY_SUBJECT in').in('EDGE_EVENT_ISGENERATEDBY_SUBJECT out').out('EDGE_EVENT_AFFECTS_NETFLOW out').out('EDGE_EVENT_AFFECTS_NETFLOW in').select('process').dedup().id()",
        "feature_set": {
            "max_num_local_net_access":
                "x={id};g.V(x).in('EDGE_EVENT_ISGENERATEDBY_SUBJECT in').in('EDGE_EVENT_ISGENERATEDBY_SUBJECT out').out('EDGE_EVENT_AFFECTS_NETFLOW out').out('EDGE_EVENT_AFFECTS_NETFLOW in').dedup().groupCount().by{{x=it.value('dstAddress');x.substring(0,x.indexOf('.',x.indexOf('.',0)+1))}}.next().values().max()"
        }
    },

    "process_connect_rare_ip" : {
        "description": "Analyze process nodes that have rare ip access",
        "instance_set": "g.V().has('subjectType',0).as('process').in('EDGE_EVENT_ISGENERATEDBY_SUBJECT in').in('EDGE_EVENT_ISGENERATEDBY_SUBJECT out').out('EDGE_EVENT_AFFECTS_NETFLOW out').out('EDGE_EVENT_AFFECTS_NETFLOW in').select('process').dedup().id()",
        "feature_set": {
            "num_distinct_dst_ip_access":
                "x={id};g.V(x).in('EDGE_EVENT_ISGENERATEDBY_SUBJECT in').in('EDGE_EVENT_ISGENERATEDBY_SUBJECT out').out('EDGE_EVENT_AFFECTS_NETFLOW out').out('EDGE_EVENT_AFFECTS_NETFLOW in').values('dstAddress').dedup().count()"
        }
    },

    "process_long_write_to_netflow" : {
        "description" : "Identify process nodes with long writing delay (potential exfiltration)",
        "instance_set": "g.V().has('subjectType',0).as('process').local(__.in('EDGE_EVENT_ISGENERATEDBY_SUBJECT in').in('EDGE_EVENT_ISGENERATEDBY_SUBJECT out').has('eventType',21).as('netflow_write').out('EDGE_EVENT_AFFECTS_NETFLOW out').out('EDGE_EVENT_AFFECTS_NETFLOW in').select('netflow_write').count().is(gt(1))).select('process').dedup().id()",
        "feature_set": {
            "first_last_write_gap":
                "(x={id};g.V(x).in('EDGE_EVENT_ISGENERATEDBY_SUBJECT in').in('EDGE_EVENT_ISGENERATEDBY_SUBJECT out').has('eventType',21).values('startedAtTime').max().next() - x={id};g.V(x).in('EDGE_EVENT_ISGENERATEDBY_SUBJECT in').in('EDGE_EVENT_ISGENERATEDBY_SUBJECT out').has('eventType',21).values('startedAtTime').min().next())/1.0e6",
            "num_writes":
                "x={id};g.V(x).in('EDGE_EVENT_ISGENERATEDBY_SUBJECT in').in('EDGE_EVENT_ISGENERATEDBY_SUBJECT out').has('eventType',21).count()"
        }
    },

    "process_write_rate_to_netflow" : {
        "description" : "Identify process with slow write rate (potential exfiltration)",
        "instance_set": "g.V().has('subjectType',0).as('process').local(__.in('EDGE_EVENT_ISGENERATEDBY_SUBJECT in').in('EDGE_EVENT_ISGENERATEDBY_SUBJECT out').has('eventType',21).as('netflow_write').out('EDGE_EVENT_AFFECTS_NETFLOW out').out('EDGE_EVENT_AFFECTS_NETFLOW in').select('netflow_write').count().is(gt(1))).select('process').dedup().id()",
        "feature_set": {
            "write_rate":
                "x={id};y=g.V(x).in('EDGE_EVENT_ISGENERATEDBY_SUBJECT in').in('EDGE_EVENT_ISGENERATEDBY_SUBJECT out').has('eventType',21).as('netflow_write').out('EDGE_EVENT_AFFECTS_NETFLOW out').out('EDGE_EVENT_AFFECTS_NETFLOW in').select('netflow_write').values('size').sum().next();x={id};z=g.V(x).in('EDGE_EVENT_ISGENERATEDBY_SUBJECT in').in('EDGE_EVENT_ISGENERATEDBY_SUBJECT out').has('eventType',21).values('startedAtTime').max().next();x={id};w=g.V(x).in('EDGE_EVENT_ISGENERATEDBY_SUBJECT in').in('EDGE_EVENT_ISGENERATEDBY_SUBJECT out').has('eventType',21).values('startedAtTime').min().next();(y/((z-w)/1.0e6))",
            "time_gap_per_writes":
                "x={id};y=g.V(x).in('EDGE_EVENT_ISGENERATEDBY_SUBJECT in').in('EDGE_EVENT_ISGENERATEDBY_SUBJECT out').has('eventType',21).values('startedAtTime').max().next();x={id};z=g.V(x).in('EDGE_EVENT_ISGENERATEDBY_SUBJECT in').in('EDGE_EVENT_ISGENERATEDBY_SUBJECT out').has('eventType',21).values('startedAtTime').min().next();x={id};w=g.V(x).in('EDGE_EVENT_ISGENERATEDBY_SUBJECT in').in('EDGE_EVENT_ISGENERATEDBY_SUBJECT out').has('eventType',21).count();(((x-y)/1.0e6)/w)"
        }
    },

    "process_access_file_attributes" : {
        "description" : "Analyze process that access attributes of files",
        "instance_set": "g.V().has('subjectType',0).and(__.in('EDGE_EVENT_ISGENERATEDBY_SUBJECT in').in('EDGE_EVENT_ISGENERATEDBY_SUBJECT out').has('eventType',9),__.in('EDGE_EVENT_ISGENERATEDBY_SUBJECT in').in('EDGE_EVENT_ISGENERATEDBY_SUBJECT out').has('eventType',14)).id()",
        "feature_set": {
            "num_chk_attrib":
                "x={id};g.V(x).in('EDGE_EVENT_ISGENERATEDBY_SUBJECT in').in('EDGE_EVENT_ISGENERATEDBY_SUBJECT out').has('eventType',9).count()",
            "num_modify_attrib":
                "x={id};g.V(x).in('EDGE_EVENT_ISGENERATEDBY_SUBJECT in').in('EDGE_EVENT_ISGENERATEDBY_SUBJECT out').has('eventType',14).count()"
        }
    },



    "files_connected_with_netflow" : {
        "description" : "Analyze files that have connection with netflow (potential downloaded files)",
        "instance_set" : "g.V().has('subjectType',4).as('net_events').out('EDGE_EVENT_AFFECTS_NETFLOW out').select('net_events').out('EDGE_EVENT_ISGENERATEDBY_SUBJECT out').out('EDGE_EVENT_ISGENERATEDBY_SUBJECT in').dedup().in('EDGE_EVENT_ISGENERATEDBY_SUBJECT in').in('EDGE_EVENT_ISGENERATEDBY_SUBJECT out').out('EDGE_EVENT_AFFECTS_FILE out').out('EDGE_EVENT_AFFECTS_FILE in').dedup().id()",
        "feature_set" : {
            "num_exec":
                "x={id};g.V(x).in('EDGE_EVENT_AFFECTS_FILE in').in('EDGE_EVENT_AFFECTS_FILE out').has('eventType',3).count()",
            "num_close":
                "x={id};g.V(x).in('EDGE_EVENT_AFFECTS_FILE in').in('EDGE_EVENT_AFFECTS_FILE out').has('eventType',5).count()",
            "num_chk_attrib":
                "x={id};g.V(x).in('EDGE_EVENT_AFFECTS_FILE in').in('EDGE_EVENT_AFFECTS_FILE out').has('eventType',9).count()",
            "num_modify_attrib":
                "x={id};g.V(x).in('EDGE_EVENT_AFFECTS_FILE in').in('EDGE_EVENT_AFFECTS_FILE out').has('eventType',14).count()",
            "num_open":
                "x={id};g.V(x).in('EDGE_EVENT_AFFECTS_FILE in').in('EDGE_EVENT_AFFECTS_FILE out').has('eventType',16).count()",
            "num_read":
                "x={id};g.V(x).in('EDGE_EVENT_AFFECTS_FILE in').in('EDGE_EVENT_AFFECTS_FILE out').has('eventType',17).count()",
            "num_rename":
                "x={id};g.V(x).in('EDGE_EVENT_AFFECTS_FILE in').in('EDGE_EVENT_AFFECTS_FILE out').has('eventType',20).count()",
            "num_write":
                "x={id};g.V(x).in('EDGE_EVENT_AFFECTS_FILE in').in('EDGE_EVENT_AFFECTS_FILE out').has('eventType',21).count()",
            "num_uploads":
                "x={id};g.V(x).in('EDGE_EVENT_AFFECTS_FILE in').in('EDGE_EVENT_AFFECTS_FILE out').has('eventType',17).as('file_read').out('EDGE_EVENT_ISGENERATEDBY_SUBJECT out').out('EDGE_EVENT_ISGENERATEDBY_SUBJECT in').as('process').in('EDGE_EVENT_ISGENERATEDBY_SUBJECT in').in('EDGE_EVENT_ISGENERATEDBY_SUBJECT out').has('eventType',21).as('netflow_write').out('EDGE_EVENT_AFFECTS_NETFLOW out').out('EDGE_EVENT_AFFECTS_NETFLOW in').dedup().count()"
        }
    },

    "files_executed" : {
        "description" : "Analyze executed files",
        "instance_set" : "g.V().has('eventType',9).out('EDGE_EVENT_AFFECTS_FILE out').out('EDGE_EVENT_AFFECTS_FILE in').dedup().id()",
        "feature_set" : {
            "num_exec":
                "x={id};g.V(x).in('EDGE_EVENT_AFFECTS_FILE in').in('EDGE_EVENT_AFFECTS_FILE out').has('eventType',3).count()",
            "num_close":
                "x={id};g.V(x).in('EDGE_EVENT_AFFECTS_FILE in').in('EDGE_EVENT_AFFECTS_FILE out').has('eventType',5).count()",
            "num_chk_attrib":
                "x={id};g.V(x).in('EDGE_EVENT_AFFECTS_FILE in').in('EDGE_EVENT_AFFECTS_FILE out').has('eventType',9).count()",
            "num_modify_attrib":
                "x={id};g.V(x).in('EDGE_EVENT_AFFECTS_FILE in').in('EDGE_EVENT_AFFECTS_FILE out').has('eventType',14).count()",
            "num_open":
                "x={id};g.V(x).in('EDGE_EVENT_AFFECTS_FILE in').in('EDGE_EVENT_AFFECTS_FILE out').has('eventType',16).count()",
            "num_read":
                "x={id};g.V(x).in('EDGE_EVENT_AFFECTS_FILE in').in('EDGE_EVENT_AFFECTS_FILE out').has('eventType',17).count()",
            "num_rename":
                "x={id};g.V(x).in('EDGE_EVENT_AFFECTS_FILE in').in('EDGE_EVENT_AFFECTS_FILE out').has('eventType',20).count()",
            "num_write":
                "x={id};g.V(x).in('EDGE_EVENT_AFFECTS_FILE in').in('EDGE_EVENT_AFFECTS_FILE out').has('eventType',21).count()"
        }
    },

    "file_open_close_gap" : {
        "description" : "Identify files that are open for long time",
        "instance_set": "g.V().has('eventType',5).out('EDGE_EVENT_AFFECTS_FILE out').out('EDGE_EVENT_AFFECTS_FILE in').dedup().as('files').in('EDGE_EVENT_AFFECTS_FILE in').in('EDGE_EVENT_AFFECTS_FILE out').has('eventType',16).select('files').dedup().id()",
        "feature_set": {
            "open_close_gap":
                "x={id};y=g.V(x).in('EDGE_EVENT_AFFECTS_FILE in').in('EDGE_EVENT_AFFECTS_FILE out').has('eventType',5).values('startedAtTime').max().next();x={id};z=g.V(x).in('EDGE_EVENT_AFFECTS_FILE in').in('EDGE_EVENT_AFFECTS_FILE out').has('eventType',16).values('startedAtTime').min().next();((y-z)/1.0e6)"
        }
    },

    "files_connect_netflow_long_write" : {
        "description" : "Identify files connected with netflow and with long writing delay (potential exfiltration)",
        "instance_set" : "g.V().has('eventType',21).as('write_events').out('EDGE_EVENT_AFFECTS_NETFLOW out').select('write_events').out('EDGE_EVENT_ISGENERATEDBY_SUBJECT out').out('EDGE_EVENT_ISGENERATEDBY_SUBJECT in').dedup().in('EDGE_EVENT_ISGENERATEDBY_SUBJECT in').in('EDGE_EVENT_ISGENERATEDBY_SUBJECT out').has('eventType',21).out('EDGE_EVENT_AFFECTS_FILE out').out('EDGE_EVENT_AFFECTS_FILE in').dedup().id()",
        "feature_set": {
            "first_last_write_gap":
                "x={id};y=g.V(x).in('EDGE_EVENT_AFFECTS_FILE in').in('EDGE_EVENT_AFFECTS_FILE out').has('eventType',21).values('startedAtTime').max().next();x={id};z=g.V(x).in('EDGE_EVENT_AFFECTS_FILE in').in('EDGE_EVENT_AFFECTS_FILE out').has('eventType',21).values('startedAtTime').min().next();((y-z)/1.0e6)",
            "num_writes":
                "x={id};g.V(x).in('EDGE_EVENT_AFFECTS_FILE in').in('EDGE_EVENT_AFFECTS_FILE out').has('eventType',21).count()"
        }
    },

    "file_dnld_exec_gap" : {
        "description" : "Detect files that are executed right after download",
        "instance_set": "g.V().has('eventType',9).out('EDGE_EVENT_AFFECTS_FILE out').out('EDGE_EVENT_AFFECTS_FILE in').dedup().as('files').in('EDGE_EVENT_AFFECTS_FILE in').in('EDGE_EVENT_AFFECTS_FILE out').has('eventType',21).select('files').dedup().id()",
        "feature_set": {
            "dnld_exec_gap":
                "x={id};y=g.V(x).in('EDGE_EVENT_AFFECTS_FILE in').in('EDGE_EVENT_AFFECTS_FILE out').has('eventType',9).values('startedAtTime').min().next();x={id};z=g.V(x).in('EDGE_EVENT_AFFECTS_FILE in').in('EDGE_EVENT_AFFECTS_FILE out').has('eventType',21).values('startedAtTime').max().next();(y-z)/1.0e6"
        }
    },

    "file_attrib_change_exec_gap" : {
        "description" : "Detect files that are executed right after permission change",
        "instance_set": "g.V().has('eventType',9).out('EDGE_EVENT_AFFECTS_FILE out').out('EDGE_EVENT_AFFECTS_FILE in').dedup().as('files').in('EDGE_EVENT_AFFECTS_FILE in').in('EDGE_EVENT_AFFECTS_FILE out').has('eventType',14).select('files').dedup().id()",
        "feature_set": {
            "attrib_change_exec_gap":
                "x={id};y=g.V(x).in('EDGE_EVENT_AFFECTS_FILE in').in('EDGE_EVENT_AFFECTS_FILE out').has('eventType',9).values('startedAtTime').min().next();x={id};z=g.V(x).in('EDGE_EVENT_AFFECTS_FILE in').in('EDGE_EVENT_AFFECTS_FILE out').has('eventType',14).values('startedAtTime').max().next();(y-z)/1.0e6"
        }
    },

    "file_exec_del_gap" : {
        "description" : "Detect files that are deleted right after execution",
        "instance_set": "g.V().has('eventType',9).out('EDGE_EVENT_AFFECTS_FILE out').out('EDGE_EVENT_AFFECTS_FILE in').dedup().as('files').in('EDGE_EVENT_AFFECTS_FILE in').in('EDGE_EVENT_AFFECTS_FILE out').has('eventType',12).select('files').dedup().id()",
        "feature_set": {
            "exec_del_gap":
                "x={id};y=g.V(x).in('EDGE_EVENT_AFFECTS_FILE in').in('EDGE_EVENT_AFFECTS_FILE out').has('eventType',9).values('startedAtTime').max().next(); x={id};z=g.V(x).in('EDGE_EVENT_AFFECTS_FILE in').in('EDGE_EVENT_AFFECTS_FILE out').has('eventType',12).values('startedAtTime').min().next();(y-z)/1.0e6"
        }
    },

    "file_upload_del_gap" : {
        "description" : "Detect files that are deleted right after upload",
        "instance_set": "g.V().has('eventType',12).out('EDGE_EVENT_AFFECTS_FILE out').out('EDGE_EVENT_AFFECTS_FILE in').dedup().as('files').in('EDGE_EVENT_AFFECTS_FILE in').in('EDGE_EVENT_AFFECTS_FILE out').has('eventType',17).out('EDGE_EVENT_ISGENERATEDBY_SUBJECT out').out('EDGE_EVENT_ISGENERATEDBY_SUBJECT in').dedup().in('EDGE_EVENT_ISGENERATEDBY_SUBJECT in').in('EDGE_EVENT_ISGENERATEDBY_SUBJECT out').has('eventType',21).out('EDGE_EVENT_AFFECTS_NETFLOW out').out('EDGE_EVENT_AFFECTS_NETFLOW in').select('files').dedup().id()",
        "feature_set": {
            "upload_del_gap":
                "x={id};y=g.V(x).in('EDGE_EVENT_AFFECTS_FILE in').in('EDGE_EVENT_AFFECTS_FILE out').has('eventType',17).out('EDGE_EVENT_ISGENERATEDBY_SUBJECT out').out('EDGE_EVENT_ISGENERATEDBY_SUBJECT in').dedup().in('EDGE_EVENT_ISGENERATEDBY_SUBJECT in').in('EDGE_EVENT_ISGENERATEDBY_SUBJECT out').has('eventType',21).as('netflow_write').out('EDGE_EVENT_AFFECTS_NETFLOW out').out('EDGE_EVENT_AFFECTS_NETFLOW in').select('netflow_write').values('startedAtTime').max().next();x={id};z=g.V(x).in('EDGE_EVENT_AFFECTS_FILE in').in('EDGE_EVENT_AFFECTS_FILE out').has('eventType',12).values('startedAtTime').min().next();(y-z)/1.0e6"
        }
    },

    "file_last_write_upload_gap" : {
        "description" : "Detect files that are uploaded right after write (potential exfiltration)",
        "instance_set": "g.V().has('eventType',21).as('write_events').out('EDGE_EVENT_AFFECTS_NETFLOW out').select('write_events').out('EDGE_EVENT_ISGENERATEDBY_SUBJECT out').out('EDGE_EVENT_ISGENERATEDBY_SUBJECT in').dedup().in('EDGE_EVENT_ISGENERATEDBY_SUBJECT in').in('EDGE_EVENT_ISGENERATEDBY_SUBJECT out').has('eventType',17).out('EDGE_EVENT_AFFECTS_FILE out').out('EDGE_EVENT_AFFECTS_FILE in').dedup().id()",
        "feature_set": {
            "exec_del_gap":
                "x={id};y=g.V(x).in('EDGE_EVENT_AFFECTS_FILE in').in('EDGE_EVENT_AFFECTS_FILE out').has('eventType',17).values('startedAtTime').max().next();x={id};z=g.V(x).in('EDGE_EVENT_AFFECTS_FILE in').in('EDGE_EVENT_AFFECTS_FILE out').has('eventType',21).values('startedAtTime').min().next();(y-z)/1.0e6"
        }
    },

    "files_executed_attribute_access" : {
        "description" : "Analyze file attribute access/change for executed files",
        "instance_set": "g.V().has('eventType',9).out('EDGE_EVENT_AFFECTS_FILE out').out('EDGE_EVENT_AFFECTS_FILE in').dedup().id()",
        "feature_set": {
            "num_chk_attrib":
                "x={id};g.V(x).in('EDGE_EVENT_AFFECTS_FILE in').in('EDGE_EVENT_AFFECTS_FILE out').has('eventType',9).count()",
            "num_modify_attrib":
                "x={id};g.V(x).in('EDGE_EVENT_AFFECTS_FILE in').in('EDGE_EVENT_AFFECTS_FILE out').has('eventType',14).count()"
        }
    },

    "files_in_tmp_dir" : {
        "description" : "Analyze the files in temp directory",
        "instance_set": "g.V().has('url',textContains('/tmp')).id()",
        "feature_set": {
            "num_exec":
                "x={id};g.V(x).in('EDGE_EVENT_AFFECTS_FILE in').in('EDGE_EVENT_AFFECTS_FILE out').has('eventType',3).count()",
            "num_chk_attrib":
                "x={id};g.V(x).in('EDGE_EVENT_AFFECTS_FILE in').in('EDGE_EVENT_AFFECTS_FILE out').has('eventType',9).count()",
            "num_modify_attrib":
                "x={id};g.V(x).in('EDGE_EVENT_AFFECTS_FILE in').in('EDGE_EVENT_AFFECTS_FILE out').has('eventType',14).count()"
        }
    }
}
